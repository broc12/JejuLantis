<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace = "query.rentcarSearch">

<resultMap type="Rcar" id="rentcarSearchResult">
	<result column="CAR_NAME" property="car_name"/>
	<result column="CAR_MANUFACTURER" property="car_manufacturer"/>
	<result column="CAR_TYPE" property="car_type"/>
	<result column="CAR_PASSENGER" property="car_passenger"/>
	<result column="CAR_FUEL" property="car_fuel"/>	
	<result column="MTOT" property="mtot"/>
	<result column="ACTOT" property="actot"/>
	<collection property="blist" javaType="java.util.ArrayList" resultMap="query.blist.BlistResult"/>
</resultMap>
<select id="rentcarsearch" parameterType="SearchRequirements" resultMap="rentcarSearchResult">
SELECT
    CAR_NAME,
    CAR_MANUFACTURER,
    CAR_TYPE,
    CAR_PASSENGER,
    CAR_FUEL,
    MTOT,
    SUM(AC) OVER(PARTITION BY CAR_NO) ACTOT,
    AC,
    BRANCH_NAME,
    CAR_KIND_PRICE_WEEK,
    INSURANCE_PRICE,
    INSURANCE_LIMIT,
    TOT,
    BRANCH_NO,
    CAR_NO,
    INSURANCE_NO,
    CAR_KIND_NO,
    CAR_KIND_NAVI,
    CAR_KIND_SENSOR,
    CAR_KIND_BLUETOOTH,
    CAR_KIND_BLACKBOX,
    CAR_KIND_SUNROOF,
    CAR_KIND_CAMERA,
    CAR_KIND_NONSMOKE
FROM
    CAR
NATURAL JOIN
    (SELECT
        BRANCH_NAME,
        AC,
        CAR_KIND_PRICE_WEEK,
        INSURANCE_PRICE,
        INSURANCE_LIMIT,
        MTOT,
        TOT,
        BRANCH_NO,
        CAR_NO,
        INSURANCE_NO,
        CAR_KIND_NO,
        CAR_KIND_NAVI,
        CAR_KIND_SENSOR,
        CAR_KIND_BLUETOOTH,
        CAR_KIND_BLACKBOX,
        CAR_KIND_SUNROOF,
        CAR_KIND_CAMERA,
        CAR_KIND_NONSMOKE
    FROM
        BRANCH
    NATURAL JOIN
        (select
            AC,
            CAR_KIND_PRICE_WEEK,
            INSURANCE_PRICE,
            INSURANCE_LIMIT,
            MIN(CAR_KIND_PRICE_WEEK+INSURANCE_PRICE) OVER(PARTITION BY CAR_NO) AS MTOT,
            (CAR_KIND_PRICE_WEEK * #{weekTime}+CAR_KIND_PRICE_WEEKEND * #{weekendTime} + INSURANCE_PRICE * #{period}) AS TOT,
            BRANCH_NO,
            CAR_NO,
            INSURANCE_NO,
            CAR_KIND_NO,
            CAR_KIND_NAVI,
            CAR_KIND_SENSOR,
            CAR_KIND_BLUETOOTH,
            CAR_KIND_BLACKBOX,
            CAR_KIND_SUNROOF,
            CAR_KIND_CAMERA,
            CAR_KIND_NONSMOKE
        from
            INSURANCE
        natural join
            (select
                K.*,
                K.CAR_KIND_TOTAL-(NVL(J1.MUC,0))AC
            from
                CAR_KIND K,
                (select
                    CAR_KIND_NO,
                    MAX(UC) MUC
                from
                    (select
                        CAR_KIND_NO,
                        D.DA,
                        count(*)UC
                    from
                        RENT_RESERV V,
                        (SELECT
                            (TO_DATE('2018-07-30 00:00','yyyy-mm-dd hh24:mi') + LEVEL -1)DA
                        FROM
                            DUAL
                        CONNECT BY
                            LEVEL 
							<![CDATA[>=]]> (TRUNC(TO_DATE('2018-08-05 18:30','yyyy-mm-dd hh24:mi') - TO_DATE('2018-07-30 08:30','yyyy-mm-dd hh24:mi')) +1))D
                        where
                            RENT_RESERV_END <![CDATA[>]]> DA
                        AND
                            RENT_RESERV_START <![CDATA[<]]> (DA+1)
                        group by
                            CAR_KIND_NO,
                            D.DA
                        order by
                            D.DA
                        )
                    group by CAR_KIND_NO
                )J1
            <where>
                J1.CAR_KIND_NO (+)= K.CAR_KIND_NO
				<if test="car_kind_navi != '' and car_kind_navi != null ">
					AND CAR_KIND_NAVI=#{car_kind_navi}
				</if>
				<if test="car_kind_sensor != '' and car_kind_sensor != null ">
					AND CAR_KIND_SENSOR=#{car_kind_sensor}
				</if>
				<if test="car_kind_blackbox != '' and car_kind_blackbox != null ">
					AND CAR_KIND_BLACKBOX=#{car_kind_blackbox}
				</if>
				<if test="car_kind_bluetooth != '' and car_kind_bluetooth != null ">
					AND CAR_KIND_BLUETOOTH=#{car_kind_bluetooth}
				</if>
				<if test="car_kind_sunroof != '' and car_kind_sunroof != null ">
					AND CAR_KIND_SUNROOF=#{car_kind_sunroof}
				</if>
				<if test="car_kind_camera != '' and car_kind_camera != null ">
					AND CAR_KIND_CAMERA=#{car_kind_camera}
				</if>
				<if test="car_kind_nonsmoke != '' and car_kind_nonsmoke != null ">
					AND CAR_KIND_NONSMOKE=#{car_kind_nonsmoke}
				</if>
			</where>
            )J2
        WHERE
            INSURANCE_NAME='자차'
        ORDER BY
            MTOT
        )
    )
<where>
	<if test="car_name != '' and car_name != null ">
		CAR_NAME=#{car_name}
	</if>
	<if test="car_type != null">
		AND CAR_TYPE IN
		<foreach item="item" index="index" collection="car_type" open="(" separator="," close=")">
			#{item}
		</foreach>
	</if>
 	<if test="car_fuel != null">
		AND CAR_FUEL IN
		<foreach item="item" index="index" collection="car_fuel" open="(" separator="," close=")">
			#{item}
		</foreach>
	</if>
 	<if test="car_manufacturer != null">
		AND CAR_MANUFACTURER IN
		<foreach item="item" index="index" collection="car_manufacturer" open="(" separator="," close=")">
			#{item}
		</foreach>
	</if>
</where>
</select>
</mapper>